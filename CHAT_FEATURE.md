# 💬 实时对话板功能说明

## 功能概览

实时对话板是太极文件传输系统的核心功能之一，支持在手机与电脑之间即时传递文本消息和文件。所有设备实时同步，让信息传输更加便捷高效。

## 🌟 特性

### 📱 实时通信
- 基于 WebSocket (Socket.IO) 实现
- 毫秒级消息传递
- 自动重连机制
- 支持多设备同时在线

### 💬 消息类型
- **文本消息**：支持多行文本、表情符号
- **文件消息**：直接在对话中发送文件，自动上传并共享

### 👥 在线状态
- 实时显示在线用户列表
- 绿点标识在线状态
- 显示用户数量

### ✍️ 输入提示
- 显示其他用户正在输入
- 动画效果提示
- 3秒自动消失

### 🎨 界面设计
- 太极黑白主题
- 清晰的消息气泡
- 自己的消息靠右（黑色背景）
- 他人的消息靠左（灰色背景）

## 📖 使用指南

### 进入对话板

1. 登录系统
2. 点击顶部导航栏的「💬 对话板」
3. 进入实时对话界面

### 发送文本消息

**方式一：鼠标操作**
1. 在底部输入框输入消息
2. 点击「发送」按钮

**方式二：键盘快捷键**
1. 在底部输入框输入消息
2. 按 `Enter` 键发送
3. 按 `Shift + Enter` 换行

### 发送文件

1. 点击底部输入框左侧的 📎 按钮
2. 选择要发送的文件
3. 等待自动上传
4. 文件消息自动发送到对话中

**支持的文件类型**：
- 所有文件类型
- 单文件最大 1GB+
- 自动显示文件图标和大小

### 下载文件

1. 在对话中找到文件消息
2. 点击文件卡片上的「下载」按钮
3. 浏览器自动下载文件

### 查看在线用户

**桌面端**：右侧显示在线用户列表  
**移动端**：对话区域下方显示在线用户标签

## 🔧 技术实现

### 后端

#### WebSocket 服务 (`backend/src/config/socket.js`)

```javascript
// 主要事件
- connection: 用户连接
- send_message: 发送文本消息
- send_file_message: 发送文件消息
- typing: 用户正在输入
- stop_typing: 停止输入
- disconnect: 用户断开

// 广播事件
- new_message: 新消息通知
- online_users: 在线用户列表更新
- user_typing: 用户输入状态
- user_stop_typing: 停止输入状态
```

#### 数据库表结构

```sql
CREATE TABLE messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  type TEXT NOT NULL,          -- 'text' 或 'file'
  content TEXT,                -- 文本内容
  file_id INTEGER,             -- 文件 ID（文件消息）
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users (id),
  FOREIGN KEY (file_id) REFERENCES files (id)
)
```

#### REST API

```
GET /api/messages
- 获取历史消息
- 分页支持 (limit, offset)
- 返回最近 100 条消息

DELETE /api/messages/:id
- 删除指定消息
- 仅能删除自己的消息

DELETE /api/messages
- 清空自己的所有消息
```

### 前端

#### Socket 连接管理 (`frontend/src/utils/socket.js`)

```javascript
// 连接管理
connectSocket(token)    // 建立连接
disconnectSocket()      // 断开连接
getSocket()             // 获取当前连接

// 消息发送
sendTextMessage(content)     // 发送文本
sendFileMessage(fileId)      // 发送文件
emitTyping()                 // 发送输入状态
emitStopTyping()             // 停止输入状态
```

#### 组件结构

```
Chat (pages/Chat.jsx)
├── Header
├── 消息列表
│   └── ChatMessage (多个)
├── 输入提示
└── ChatInput
    ├── 文件选择按钮
    ├── 输入框
    └── 发送按钮
```

## 🎯 使用场景

### 场景一：电脑到手机传文本

1. 在电脑上打开对话板
2. 输入要传递的文本（如链接、地址）
3. 按 Enter 发送
4. 在手机上打开对话板
5. 立即看到消息并复制

### 场景二：手机到电脑传照片

1. 在手机上打开对话板
2. 点击 📎 按钮选择照片
3. 等待上传完成
4. 在电脑上打开对话板
5. 点击下载按钮保存照片

### 场景三：多设备协作

1. 在手机、平板、电脑同时登录
2. 任何设备发送消息
3. 所有设备实时接收
4. 完美的多设备同步体验

### 场景四：临时文件分享

1. 不想保存到文件列表
2. 在对话板中快速发送
3. 对方立即接收
4. 用完即走

## ⚙️ 配置说明

### 连接地址

默认连接到 `http://localhost:5000`

**局域网访问**：
修改 `frontend/src/utils/socket.js` 中的连接地址：

```javascript
socket = io('http://<你的电脑IP>:5000', {
  // ...
});
```

### 认证

WebSocket 连接需要 JWT Token：

```javascript
socket = io('http://localhost:5000', {
  auth: {
    token: '<your-jwt-token>'
  }
});
```

系统会自动从 localStorage 读取 token。

### 消息历史

默认加载最近 100 条消息，可在 API 调用时修改：

```javascript
axios.get('/api/messages?limit=50&offset=0')
```

## 🔒 安全性

### 认证机制
- WebSocket 连接需要有效的 JWT Token
- 未认证用户无法连接
- Token 过期自动断开连接

### 消息权限
- 仅能查看自己所在房间的消息
- 仅能删除自己发送的消息
- 文件消息需要验证文件所有权

### 数据传输
- 建议生产环境使用 HTTPS/WSS
- Token 不应在 URL 中传递
- 使用 auth 参数传递认证信息

## 🐛 常见问题

### Q1: 连接失败

**原因**：
- 后端未启动
- 防火墙阻止
- Token 无效

**解决**：
1. 确认后端正常运行
2. 检查控制台错误信息
3. 尝试重新登录获取新 Token

### Q2: 消息不实时

**原因**：
- 网络延迟
- WebSocket 连接断开
- 浏览器限制

**解决**：
1. 刷新页面重新连接
2. 检查网络连接
3. 查看控制台 WebSocket 状态

### Q3: 文件上传卡住

**原因**：
- 文件太大
- 网络中断
- 服务器繁忙

**解决**：
1. 等待上传完成（查看进度）
2. 检查网络连接
3. 尝试发送较小的文件

### Q4: 输入提示不显示

**原因**：
- 正常功能，3秒后自动消失
- 对方停止输入
- WebSocket 事件未触发

**解决**：
- 这是正常行为
- 继续输入会重新显示

## 📊 性能优化

### 客户端

1. **消息分页加载**
   - 一次加载 100 条
   - 滚动加载更多
   - 避免一次性加载全部

2. **自动滚动优化**
   - 使用 smooth 滚动
   - 仅在接收新消息时滚动
   - 避免频繁触发

3. **输入防抖**
   - 输入状态 3 秒后自动清除
   - 避免频繁发送事件

### 服务器端

1. **在线用户管理**
   - 使用 Map 存储在线用户
   - 自动清理断开连接的用户

2. **消息广播**
   - 使用 Socket.IO 的房间机制
   - 减少不必要的广播

3. **数据库查询**
   - 索引优化
   - 限制查询数量
   - 使用分页

## 🚀 未来增强

### 计划中的功能

- [ ] 消息已读状态
- [ ] 消息撤回
- [ ] @提及用户
- [ ] 消息搜索
- [ ] 表情包支持
- [ ] 语音消息
- [ ] 视频通话
- [ ] 屏幕共享
- [ ] 消息加密
- [ ] 离线消息推送

### 可扩展性

系统设计考虑了可扩展性：
- 模块化的 Socket 事件处理
- 独立的消息表结构
- 灵活的消息类型系统
- 易于添加新的消息类型

## 💡 最佳实践

### 使用建议

1. **及时清理消息**：定期清空不需要的聊天记录
2. **合理使用文件消息**：大文件建议通过文件列表分享
3. **多设备登录**：手机和电脑同时在线效果最佳
4. **网络环境**：使用稳定的 Wi-Fi 连接

### 开发建议

1. **错误处理**：捕获所有 Socket 错误
2. **重连机制**：Socket.IO 自带重连
3. **状态管理**：使用 React Hooks 管理状态
4. **性能监控**：关注消息发送和接收延迟

---

**享受实时对话带来的便捷！** 💬⚡

