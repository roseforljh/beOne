const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/web-tf8e4SxZ.js","assets/js/index-uVwVOvxz.js","assets/js/react-vendor-D3OtlHN5.js","assets/js/utils-vendor-C4paqCkD.js","assets/css/index-D5h5Hihx.css","assets/js/socket-vendor-Ba10ZAmw.js","assets/js/web-Onlg9KwF.js"])))=>i.map(i=>d[i]);
import{a as e}from"./utils-vendor-C4paqCkD.js";import{C as t,b as s,r as i,_ as o,A as a}from"./index-uVwVOvxz.js";import{l as r}from"./socket-vendor-Ba10ZAmw.js";const n=t.isNativePlatform()?1048576:2097152,l=t.isNativePlatform()?5:6;class h{constructor(e,t,s,i="user"){this.file=e,this.onProgress=t,this.onSpeedUpdate=s,this.source=i,this.uploadId=null,this.totalChunks=Math.ceil(e.size/n),this.uploadedBytes=0,this.uploadedChunks=new Set,this.startTime=null,this.lastUpdateTime=null,this.lastUploadedBytes=0,this.aborted=!1,this.cancelTokenSources=new Map,this.retryCount=new Map,this.maxRetries=3,this.lastReportedProgress=0,this.progressUpdateTimer=null,this.isFinished=!1}abort(){this.aborted=!0,this.cancelTokenSources.forEach(e=>{e.cancel("‰∏ä‰º†Â∑≤ÂèñÊ∂à")}),this.cancelTokenSources.clear(),this.progressUpdateTimer&&(clearInterval(this.progressUpdateTimer),this.progressUpdateTimer=null)}cancel(){this.abort()}async upload(){if(this.isFinished)return{success:!1,error:"Upload already finished"};try{if(this.startTime=Date.now(),this.lastUpdateTime=this.startTime,this.file.size<5242880)return await this.uploadDirectly();t.isNativePlatform()&&this.startProgressTimer();const e=await s.post("/api/upload/init",{filename:this.file.name,totalChunks:this.totalChunks,fileSize:this.file.size,mimetype:this.file.type,source:this.source});if(this.uploadId=e.data.uploadId,await this.uploadChunksConcurrently(),this.aborted)throw new Error("‰∏ä‰º†Â∑≤ÂèñÊ∂à");const i=await s.post("/api/upload/complete",{uploadId:this.uploadId,filename:this.file.name,totalChunks:this.totalChunks,mimetype:this.file.type,source:this.source});return this.progressUpdateTimer&&(clearInterval(this.progressUpdateTimer),this.progressUpdateTimer=null),this.isFinished=!0,this.onProgress&&this.onProgress(100),i.data&&i.data.file?{success:!0,file:i.data.file}:{success:!1,error:"ÊúçÂä°Âô®ÂìçÂ∫îÊ†ºÂºèÈîôËØØ"}}catch(e){return this.isFinished=!0,this.progressUpdateTimer&&(clearInterval(this.progressUpdateTimer),this.progressUpdateTimer=null),this.aborted||"‰∏ä‰º†Â∑≤ÂèñÊ∂à"===e.message?{success:!1,cancelled:!0,error:"‰∏ä‰º†Â∑≤ÂèñÊ∂à"}:{success:!1,error:e.response?.data?.error||"‰∏ä‰º†Â§±Ë¥•"}}}async uploadDirectly(){try{const e=new FormData;e.append("file",this.file),e.append("filename",this.file.name),e.append("mimetype",this.file.type),e.append("source",this.source);const i=await s.post("/api/upload/direct",e,{timeout:t.isNativePlatform()?6e4:3e4,onUploadProgress:e=>{if(this.aborted)return;const t=e.loaded/e.total*100;this.onProgress&&this.onProgress(Math.min(t,99))}});return this.isFinished=!0,this.onProgress&&this.onProgress(100),i.data&&i.data.file?{success:!0,file:i.data.file}:{success:!1,error:"ÊúçÂä°Âô®ÂìçÂ∫îÊ†ºÂºèÈîôËØØ"}}catch(e){return this.isFinished=!0,this.aborted?{success:!1,cancelled:!0,error:"‰∏ä‰º†Â∑≤ÂèñÊ∂à"}:{success:!1,error:e.response?.data?.error||e.message||"‰∏ä‰º†Â§±Ë¥•"}}}async uploadChunksConcurrently(){const e=[...Array.from({length:this.totalChunks},(e,t)=>t)],t=new Set,s=async()=>{if(0===e.length||this.aborted)return;const i=e.shift(),o=this.uploadChunkWithRetry(i).finally(()=>{if(t.delete(o),e.length>0&&!this.aborted)return s()});return t.add(o),o},i=Array.from({length:Math.min(l,this.totalChunks)},()=>s());for(await Promise.all(i);t.size>0;)await Promise.race(t)}async uploadChunkWithRetry(e,t=0){try{await this.uploadChunk(e)}catch(s){if(this.aborted||"‰∏ä‰º†Â∑≤ÂèñÊ∂à"===s.message)throw s;if(t<this.maxRetries)return await new Promise(e=>setTimeout(e,1e3*(t+1))),this.uploadChunkWithRetry(e,t+1);throw s}}async uploadChunk(i){if(this.aborted)throw new Error("‰∏ä‰º†Â∑≤ÂèñÊ∂à");if(this.uploadedChunks.has(i))return;const o=i*n,a=Math.min(o+n,this.file.size),r=this.file.slice(o,a),l=new FormData;l.append("chunk",r),l.append("uploadId",this.uploadId),l.append("chunkIndex",i);const h=e.CancelToken.source();this.cancelTokenSources.set(i,h);try{await s.post("/api/upload/chunk",l,{headers:{"Content-Type":"multipart/form-data"},timeout:t.isNativePlatform()?3e4:15e3,cancelToken:h.token,onUploadProgress:e=>{this.aborted?h.cancel("‰∏ä‰º†Â∑≤ÂèñÊ∂à"):this.updateProgress(i,e.loaded,r.size)}}),this.uploadedChunks.add(i),this.cancelTokenSources.delete(i),this.updateProgress(i,r.size,r.size)}catch(d){throw this.cancelTokenSources.delete(i),d}}startProgressTimer(){this.progressUpdateTimer=setInterval(()=>{if(this.aborted||this.isFinished)return void clearInterval(this.progressUpdateTimer);const e=this.uploadedChunks.size/this.totalChunks*100,t=Math.min(Math.max(0,e),99);Math.abs(t-this.lastReportedProgress)>=2&&(this.lastReportedProgress=t,this.onProgress&&this.onProgress(t))},500)}updateProgress(e,t,s){if(this.isFinished||this.aborted)return;const i=this.uploadedChunks.size,o=(i+t/s)/this.totalChunks*100;this.uploadedBytes=i*n+t;const a=Date.now();if(a-this.lastUpdateTime>=300){const e=(a-this.lastUpdateTime)/1e3,t=(this.uploadedBytes-this.lastUploadedBytes)/e;this.lastUpdateTime=a,this.lastUploadedBytes=this.uploadedBytes,this.onSpeedUpdate&&this.onSpeedUpdate(t)}if(this.onProgress){const e=Math.min(Math.max(0,o),99);Math.abs(e-this.lastReportedProgress)>=2&&(this.lastReportedProgress=e,this.onProgress(e))}}}const d=e=>{if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["B","KB","MB","GB","TB"][t]},c=e=>e?e.startsWith("image/")?"üñºÔ∏è":e.startsWith("video/")?"üé¨":e.startsWith("audio/")?"üéµ":e.includes("pdf")?"üìï":e.includes("word")||e.includes("document")?"üìò":e.includes("excel")||e.includes("spreadsheet")?"üìó":e.includes("powerpoint")||e.includes("presentation")?"üìô":e.includes("zip")||e.includes("rar")||e.includes("7z")?"üì¶":e.includes("text")?"üìù":"üìÑ":"üìÑ";var u,p;!function(e){e.Documents="DOCUMENTS",e.Data="DATA",e.Library="LIBRARY",e.Cache="CACHE",e.External="EXTERNAL",e.ExternalStorage="EXTERNAL_STORAGE",e.ExternalCache="EXTERNAL_CACHE",e.LibraryNoCloud="LIBRARY_NO_CLOUD",e.Temporary="TEMPORARY"}(u||(u={})),function(e){e.UTF8="utf8",e.ASCII="ascii",e.UTF16="utf16"}(p||(p={}));const m=i("Filesystem",{web:()=>o(()=>import("./web-tf8e4SxZ.js"),__vite__mapDeps([0,1,2,3,4,5])).then(e=>new e.FilesystemWeb)});!function(e=!1){typeof window>"u"||(window.CapacitorUtils=window.CapacitorUtils||{},void 0===window.Capacitor||e?void 0!==window.cordova&&function(e){e.CapacitorUtils.Synapse=new Proxy({},{get:(t,s)=>e.cordova.plugins[s]})}(window):function(e){e.CapacitorUtils.Synapse=new Proxy({},{get:(t,s)=>new Proxy({},{get:(t,i)=>(t,o,a)=>{const r=e.Capacitor.Plugins[s];void 0!==r?"function"==typeof r[i]?(async()=>{try{const e=await r[i](t);o(e)}catch(e){a(e)}})():a(new Error(`Method ${i} not found in Capacitor plugin ${s}`)):a(new Error(`Capacitor plugin ${s} not found`))}})})}(window))}();const f=i("Toast",{web:()=>o(()=>import("./web-Onlg9KwF.js"),__vite__mapDeps([6,1,2,3,4])).then(e=>new e.ToastWeb)});let w=null,g=null;const y=e=>{if(w?.connected)return w;const s=(()=>{if(t.isNativePlatform()){return localStorage.getItem("apiUrl")||a.API_URL}if("5173"===window.location.port||"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname)return`http://${window.location.hostname}:5000`;return`${"https:"===window.location.protocol?"https:":"http:"}//${window.location.hostname}${"https:"===window.location.protocol?"":":5000"}`})(),i="https:"===window.location.protocol,o=e&&e.startsWith("Bearer ")?e.substring(7):e;return w=r(s,{auth:{token:o},transports:t.isNativePlatform()?["websocket"]:["websocket","polling"],reconnection:!0,reconnectionDelay:500,reconnectionDelayMax:3e3,reconnectionAttempts:5,timeout:2e4,upgrade:!0,rememberUpgrade:!0,perMessageDeflate:{threshold:1024},forceNew:!1,multiplex:!0,enablesXDR:!1,pingInterval:25e3,pingTimeout:6e4,secure:i,rejectUnauthorized:!1,extraHeaders:i?{Authorization:`Bearer ${o}`}:{}}),w.on("connect",()=>{T()}),w.on("disconnect",()=>{C()}),w},T=()=>{C(),g=setInterval(()=>{w?.connected&&w.emit("ping")},3e4)},C=()=>{g&&(clearInterval(g),g=null)},P=()=>{w&&(C(),w.disconnect(),w=null)},U=(e,t=null)=>{w?.connected&&w.emit("send_message",{content:e,conversationId:t})},k=(e,t=null)=>{w?.connected&&w.emit("send_file_message",{fileId:e,conversationId:t})};let b=null;const I=()=>{if(w?.connected){if(b)return;w.emit("typing"),b=setTimeout(()=>{b=null},1e3)}},v=()=>{w?.connected&&w.emit("stop_typing"),b&&(clearTimeout(b),b=null)},E=e=>{w?.connected&&w.emit("recall_message",{messageId:e})};export{u as D,p as E,h as F,f as T,m as a,I as b,y as c,k as d,v as e,d as f,c as g,P as h,E as r,U as s};
