import{j as e,C as t,b as a,a as i,u as s,T as n,L as l}from"./index-uVwVOvxz.js";import{r}from"./react-vendor-D3OtlHN5.js";import{H as o}from"./Header-TXnB3V-4.js";import{a as c,T as d,D as x,f as m,r as u,g as h,s as p,e as j,b as g,F as f,d as b,c as y,h as v}from"./socket-BCDjj6Tf.js";import{m as w,A as N}from"./utils-vendor-C4paqCkD.js";import{C as k,T as C}from"./Toast-CCnghxxx.js";import"./socket-vendor-Ba10ZAmw.js";function S({onSelect:t,disabled:a,position:i="bottom"}){const[s,n]=r.useState(!1);return e.jsxs("div",{className:"relative inline-block",children:[e.jsx(w.button,{onClick:()=>n(!s),disabled:a,whileTap:{scale:.95},className:"p-2 md:px-4 md:py-3 bg-taiji-gray-200 text-taiji-black rounded-lg hover:bg-taiji-gray-300 transition-colors disabled:opacity-50 text-lg md:text-base flex items-center justify-center min-w-[44px]",title:"é€‰æ‹©æ–‡ä»¶ç±»åž‹",children:"ðŸ“Ž"}),e.jsx(N,{children:s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[9998]",onClick:()=>n(!1)}),e.jsx(w.div,{initial:{opacity:0,y:"bottom"===i?10:-10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:"bottom"===i?10:-10,scale:.95},className:`absolute ${"bottom"===i?"top-full mt-2":"bottom-full mb-2"} left-0 bg-taiji-white rounded-xl shadow-2xl border-2 border-taiji-gray-200 overflow-hidden z-[9999] min-w-[180px]`,children:[{icon:"ðŸ“·",label:"æ‹ç…§",accept:"image/*",capture:"environment"},{icon:"ðŸ–¼ï¸",label:"ç›¸å†Œ",accept:"image/*"},{icon:"ðŸŽ¬",label:"è§†é¢‘",accept:"video/*"},{icon:"ðŸŽµ",label:"éŸ³é¢‘",accept:"audio/*"},{icon:"ðŸ“„",label:"æ–‡æ¡£",accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt"},{icon:"ðŸ“",label:"æ‰€æœ‰æ–‡ä»¶",accept:"*/*"}].map((a,i)=>e.jsxs("button",{onClick:()=>(e=>{n(!1),t&&t(e)})(a),className:"w-full px-4 py-3 flex items-center gap-3 hover:bg-taiji-gray-100 transition-colors text-left border-b border-taiji-gray-100 last:border-b-0",children:[e.jsx("span",{className:"text-2xl",children:a.icon}),e.jsx("span",{className:"text-sm font-medium text-taiji-black",children:a.label})]},i))})]})})]})}const _=r.memo(function({message:s,isOwn:n,currentSessionId:l,onRecall:o}){const p=!s.session_id||s.session_id===l,[j,g]=r.useState(!1),[f,b]=r.useState(!1),[y,v]=r.useState(!1),k=r.useCallback(async()=>{if(s.file)if(t.isNativePlatform())try{if("granted"!==(await c.requestPermissions()).publicStorage)return void(await d.show({text:"éœ€è¦å­˜å‚¨æƒé™æ‰èƒ½ä¸‹è½½æ–‡ä»¶",duration:"long"}));await d.show({text:`å¼€å§‹ä¸‹è½½ ${s.file.original_name}...`,duration:"short"});const e=(await a.get(`/api/files/${s.file.id}/download`,{responseType:"blob"})).data,t=new FileReader;t.onloadend=async()=>{const e=t.result;try{await c.writeFile({path:s.file.original_name,data:e,directory:x.Documents}),await d.show({text:`${s.file.original_name} å·²ä¿å­˜æˆåŠŸ`,duration:"long"})}catch(a){await d.show({text:`æ–‡ä»¶ä¿å­˜å¤±è´¥: ${a.message}`,duration:"long"})}},t.readAsDataURL(e)}catch(e){await d.show({text:`ä¸‹è½½å¤±è´¥: ${e.message}`,duration:"long"})}else window.open(i.getDownloadUrl(s.file.id),"_blank")},[s.file]),C=r.useCallback(async()=>{try{let e="";"text"===s.type?e=s.content:"file"===s.type&&s.file&&(e=`æ–‡ä»¶: ${s.file.original_name}\nå¤§å°: ${m(s.file.size)}\né“¾æŽ¥: ${window.location.origin}${i.getDownloadUrl(s.file.id)}`),await navigator.clipboard.writeText(e),b(!0),setTimeout(()=>b(!1),2e3)}catch(e){alert("å¤åˆ¶å¤±è´¥")}},[s.type,s.content,s.file]),S=r.useCallback(()=>{v(!0)},[]),_=r.useCallback(()=>{u(s.id),o&&o(s.id),v(!1)},[s.id,o]),$=r.useCallback(()=>{v(!1)},[]),z=r.useCallback(()=>{window.innerWidth<768&&g(!j)},[j]);return e.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`flex ${p?"justify-end":"justify-start"} mb-3 md:mb-4 group`,onClick:z,children:[e.jsxs("div",{className:`max-w-[90%] md:max-w-[85%] lg:max-w-[75%] ${p?"items-end":"items-start"} flex flex-col relative`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 px-2",children:[e.jsx("span",{className:"text-xs text-taiji-gray-500 font-medium",children:s.username}),e.jsx("span",{className:"text-xs text-taiji-gray-400",children:new Date(s.created_at).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{className:"relative w-full",children:[e.jsx("div",{className:"px-3 md:px-4 py-2 md:py-3 rounded-2xl text-sm md:text-base "+(p?"bg-taiji-black text-taiji-white":"bg-taiji-gray-200 text-taiji-black"),children:"text"===s.type?e.jsx("p",{className:"whitespace-pre-wrap break-all",children:s.content}):"file"===s.type&&s.file?(()=>{const t=s.file.mimetype?.startsWith("image/"),a=s.file.mimetype?.startsWith("video/");return t?e.jsxs("div",{className:"flex flex-col gap-2 w-full max-w-[280px] md:max-w-[360px]",children:[e.jsx("div",{className:"relative w-full",children:e.jsx("img",{src:i.getThumbnailUrl(s.file.id),alt:s.file.original_name,className:"w-full h-auto rounded-lg object-cover",loading:"lazy",onError:e=>{e.target.onerror=null,e.target.src=i.getPreviewUrl(s.file.id)}})}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs opacity-75 truncate",children:s.file.original_name}),e.jsx("p",{className:"text-xs opacity-60",children:s.file.size?m(s.file.size):""})]}),e.jsx("button",{onClick:e=>{e.stopPropagation(),k()},className:"px-2 py-1 rounded-lg text-xs font-medium transition-colors whitespace-nowrap "+(p?"bg-taiji-white text-taiji-black hover:bg-taiji-gray-100":"bg-taiji-black text-taiji-white hover:bg-taiji-gray-800"),children:"ä¸‹è½½"})]})]}):a?e.jsxs("div",{className:"flex flex-col gap-2 w-full max-w-[280px] md:max-w-[360px]",children:[e.jsx("div",{className:"relative w-full",children:e.jsx("video",{src:i.getPreviewUrl(s.file.id),controls:!0,className:"w-full h-auto rounded-lg",preload:"metadata",children:"æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾"})}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs opacity-75 truncate",children:s.file.original_name}),e.jsx("p",{className:"text-xs opacity-60",children:s.file.size?m(s.file.size):""})]}),e.jsx("button",{onClick:e=>{e.stopPropagation(),k()},className:"px-2 py-1 rounded-lg text-xs font-medium transition-colors whitespace-nowrap "+(p?"bg-taiji-white text-taiji-black hover:bg-taiji-gray-100":"bg-taiji-black text-taiji-white hover:bg-taiji-gray-800"),children:"ä¸‹è½½"})]})]}):e.jsxs("div",{className:"flex items-center gap-2 md:gap-3 min-w-[180px] md:min-w-[200px]",children:[e.jsx("div",{className:"text-2xl md:text-3xl",children:h(s.file.mimetype)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate text-sm md:text-base",children:s.file.original_name||"æœªçŸ¥æ–‡ä»¶"}),e.jsx("p",{className:"text-xs opacity-75",children:s.file.size?m(s.file.size):"æœªçŸ¥å¤§å°"})]}),e.jsx("button",{onClick:e=>{e.stopPropagation(),k()},className:"px-2 md:px-3 py-1 rounded-lg text-xs font-medium transition-colors "+(p?"bg-taiji-white text-taiji-black hover:bg-taiji-gray-100":"bg-taiji-black text-taiji-white hover:bg-taiji-gray-800"),children:"ä¸‹è½½"})]})})():null}),e.jsxs("div",{className:`flex gap-1 md:gap-2 mt-2 ${n?"justify-end":"justify-start"} transition-all duration-150 ease-out ${j?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none md:group-hover:opacity-100 md:group-hover:pointer-events-auto"}`,children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),C()},className:"px-2 md:px-3 py-1 rounded-lg text-xs font-medium transition-all "+(f?"bg-green-500 text-white":n?"bg-taiji-gray-700 text-taiji-white hover:bg-taiji-gray-600":"bg-taiji-gray-300 text-taiji-black hover:bg-taiji-gray-400"),title:"å¤åˆ¶",children:f?"âœ“ å·²å¤åˆ¶":"ðŸ“‹ å¤åˆ¶"}),n&&e.jsx("button",{onClick:e=>{e.stopPropagation(),S()},className:"px-2 md:px-3 py-1 bg-red-500 text-white rounded-lg text-xs font-medium hover:bg-red-600 transition-all",title:"æ’¤å›ž",children:"â†©ï¸ æ’¤å›ž"})]})]})]}),e.jsx(N,{children:y&&e.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4",onClick:$,children:e.jsxs(w.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-white rounded-2xl shadow-2xl overflow-hidden max-w-sm w-full",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-taiji-black mb-2",children:"æ’¤å›žæ¶ˆæ¯"}),e.jsx("p",{className:"text-sm text-taiji-gray-600",children:"ç¡®å®šè¦æ’¤å›žè¿™æ¡æ¶ˆæ¯å—ï¼Ÿ"})]}),e.jsxs("div",{className:"flex border-t border-taiji-gray-200",children:[e.jsx("button",{onClick:$,className:"flex-1 py-3 text-sm font-medium text-taiji-gray-600 hover:bg-taiji-gray-50 transition-colors",children:"å–æ¶ˆ"}),e.jsx("div",{className:"w-px bg-taiji-gray-200"}),e.jsx("button",{onClick:_,className:"flex-1 py-3 text-sm font-medium text-red-500 hover:bg-red-50 transition-colors",children:"æ’¤å›ž"})]})]})})})]})}),$=r.memo(function({conversationId:t,onFileSent:a}){const[i,s]=r.useState(""),[n,l]=r.useState(!1),[o,c]=r.useState([]),[d,x]=r.useState({}),[u,h]=r.useState({}),y=r.useRef(null),v=r.useRef(null),[N,k]=r.useState("*/*"),[C,_]=r.useState(null),$=r.useRef([]),[z,L]=r.useState(new Set),T=r.useCallback(()=>{i.trim()&&(p(i.trim(),t),s(""),j())},[i,t]),M=r.useCallback(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),T())},[T]),P=r.useCallback(e=>{s(e.target.value),g(),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{j()},3e3)},[]),D=r.useCallback(e=>{L(t=>new Set([...t,e])),$.current[e]&&$.current[e].cancel()},[]),I=r.useCallback(()=>{$.current.forEach((e,t)=>{e&&(e.cancel(),L(e=>new Set([...e,t])))})},[]),R=r.useCallback(async e=>{const i=Array.from(e.target.files);if(0!==i.length)try{l(!0),c(i),L(new Set),$.current=[];const e={},n={};i.forEach((t,a)=>{e[a]=0,n[a]=0}),x(e),h(n);const r=[];for(let l=0;l<i.length;l++){if(z.has(l))continue;const e=i[l],n=new f(e,e=>{x(t=>({...t,[l]:e}))},e=>{h(t=>({...t,[l]:e}))},"chat");$.current[l]=n;try{const i=await n.upload();if(i.cancelled)continue;if(r.push({index:l,file:e,result:i}),i.success&&(b(i.file.id,t),a))try{a(i.file)}catch(s){}}catch(s){r.push({index:l,file:e,result:{success:!1,error:s.message}})}}r.filter(e=>!e.result.success&&!e.result.cancelled).length}catch(n){}finally{l(!1),c([]),x({}),h({}),L(new Set),$.current=[],y.current&&(y.current.value="")}},[t,a,z]);return e.jsxs("div",{className:"border-t-2 border-taiji-gray-200 bg-taiji-white p-2 md:p-4 pb-6 md:pb-6",children:[n&&o.length>0&&e.jsxs(w.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mb-2 md:mb-3 bg-taiji-gray-100 rounded-lg p-2 md:p-3 space-y-3 max-h-48 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs md:text-sm text-taiji-gray-600 font-medium",children:["æ­£åœ¨ä¸Šä¼  ",o.length," ä¸ªæ–‡ä»¶"]}),e.jsx("button",{onClick:I,className:"px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors",children:"å…¨éƒ¨å–æ¶ˆ"})]}),o.map((t,a)=>{const i=d[a]??0,s=u[a]??0,n=Math.min(Math.max(0,Math.round(i)),100),l=z.has(a);return e.jsxs("div",{className:"bg-taiji-white rounded-lg p-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsx("span",{className:"text-xs text-taiji-gray-700 truncate flex-1 mr-2 font-medium",children:t.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[!l&&s>0&&e.jsxs("span",{className:"text-xs text-taiji-gray-500",children:[m(s),"/s"]}),!l&&n<100&&e.jsx("button",{onClick:()=>D(a),className:"text-xs text-red-500 hover:text-red-700 font-medium",children:"âœ•"}),e.jsx("span",{className:"text-xs font-bold text-taiji-black min-w-[45px] text-right",children:l?"å·²å–æ¶ˆ":`${n}%`})]})]}),!l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full bg-taiji-gray-200 rounded-full h-2 overflow-hidden",children:e.jsx(w.div,{className:"bg-taiji-black h-full rounded-full",style:{width:`${n}%`},transition:{duration:.1,ease:"linear"}})}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("span",{className:"text-xs text-taiji-gray-500",children:m(t.size)}),100===n&&e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"âœ“ å®Œæˆ"})]})]}),l&&e.jsx("div",{className:"text-xs text-red-500 mt-1",children:"ä¸Šä¼ å·²å–æ¶ˆ"})]},a)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{ref:y,type:"file",multiple:!0,accept:N,capture:C,className:"hidden",onChange:R}),e.jsx(S,{position:"top",disabled:n,onSelect:e=>{k(e.accept),_(e.capture||null),setTimeout(()=>{y.current?.click()},100)}}),e.jsx("input",{type:"text",value:i,onChange:P,onKeyPress:M,placeholder:n?"ä¸Šä¼ ä¸­ï¼Œä»å¯è¾“å…¥æ¶ˆæ¯...":"è¾“å…¥æ¶ˆæ¯...",className:"flex-1 px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-taiji-gray-300 rounded-lg focus:border-taiji-black focus:outline-none transition-colors"}),e.jsx(w.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:T,disabled:!i.trim(),className:"px-4 md:px-6 py-2 md:py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium text-sm md:text-base min-w-[60px]",children:"å‘é€"})]})]})});function z({conversations:t,currentConversationId:i,onSelectConversation:s,onNewConversation:n,onDeleteConversation:l,onRefresh:o}){const[c,d]=r.useState(null),[x,m]=r.useState(""),[u,h]=r.useState(!1),[p,j]=r.useState(!1),[g,f]=r.useState(null),b=async e=>{if(x.trim())try{const t=x;d(null),await a.patch(`/api/conversations/${e}`,{title:t})}catch(t){o()}else d(null)},y=()=>{j(!1),f(null)};return e.jsxs("div",{className:"w-64 bg-taiji-white border-r-2 border-taiji-gray-200 flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b-2 border-taiji-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-bold text-taiji-black",children:"ä¼šè¯åˆ—è¡¨"}),e.jsx(w.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:async()=>{h(!0);try{await n()}catch(e){}finally{h(!1)}},disabled:u,className:"p-2 bg-taiji-black text-taiji-white rounded-lg hover:bg-taiji-gray-800 transition-colors disabled:opacity-50",title:"æ–°å»ºä¼šè¯",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-2 space-y-2",children:[e.jsx(N,{children:t.map(t=>e.jsx(w.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"p-3 rounded-lg cursor-pointer transition-colors group "+(i===t.id?"bg-taiji-black text-taiji-white":"bg-taiji-gray-100 hover:bg-taiji-gray-200"),children:c===t.id?e.jsx("input",{type:"text",value:x,onChange:e=>m(e.target.value),onBlur:()=>b(t.id),onKeyPress:e=>{"Enter"===e.key&&b(t.id),"Escape"===e.key&&d(null)},autoFocus:!0,className:"w-full px-2 py-1 text-sm bg-taiji-white text-taiji-black border border-taiji-gray-300 rounded",onClick:e=>e.stopPropagation()}):e.jsxs("div",{onClick:()=>s(t.id),children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-sm truncate flex-1",children:t.title}),e.jsxs("div",{className:"flex gap-1 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),d(t.id),m(t.title)},className:"p-1 hover:bg-taiji-gray-300 rounded",title:"é‡å‘½å",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})})}),e.jsx("button",{onClick:e=>{var a;e.stopPropagation(),a=t.id,f(a),j(!0)},className:"p-1 hover:bg-red-500 hover:text-white rounded",title:"åˆ é™¤",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs opacity-75",children:[e.jsxs("span",{children:[t.message_count||0," æ¡æ¶ˆæ¯"]}),e.jsx("span",{children:new Date(t.updated_at).toLocaleDateString("zh-CN")})]})]})},t.id))}),0===t.length&&e.jsxs("div",{className:"text-center py-8 text-taiji-gray-400 text-sm",children:["æš‚æ— åŽ†å²ä¼šè¯",e.jsx("br",{}),"ç‚¹å‡»ä¸Šæ–¹ + åˆ›å»ºæ–°ä¼šè¯"]})]}),e.jsx(N,{children:p&&e.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:y,children:e.jsxs(w.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-white w-80 rounded-xl shadow-xl overflow-hidden",onClick:e=>e.stopPropagation(),children:[e.jsx("div",{className:"px-5 py-4 border-b",children:e.jsx("h3",{className:"text-base font-semibold text-taiji-black",children:"ç¡®è®¤åˆ é™¤"})}),e.jsx("div",{className:"px-5 py-4 text-sm text-taiji-gray-700",children:"ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿæ‰€æœ‰æ¶ˆæ¯å°†è¢«åˆ é™¤ï¼"}),e.jsxs("div",{className:"px-5 py-3 border-t flex justify-end gap-3",children:[e.jsx("button",{onClick:y,className:"px-3 py-1.5 rounded-lg border border-taiji-gray-300 text-taiji-black hover:bg-taiji-gray-100",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:async()=>{const e=g;if(e){y();try{l&&l(e),await a.delete(`/api/conversations/${e}`),o()}catch(t){o()}}},className:"px-3 py-1.5 rounded-lg bg-red-500 text-white hover:bg-red-600",children:"åˆ é™¤"})]})]})})})]})}function L(){const{user:t,token:i}=s(),[c,d]=r.useState([]),[x,m]=r.useState(!0),[u,h]=r.useState([]),[p,j]=r.useState(new Set),[g,f]=r.useState(null),[b,S]=r.useState([]),[L,T]=r.useState(null),[M,P]=r.useState(!1),[D,I]=r.useState(!1),[R,E]=r.useState(!1),[A,F]=r.useState(""),[H,W]=r.useState("success"),B=r.useRef(null);r.useRef(new Map);const U=r.useRef(!1),O=r.useRef(null),K=r.useMemo(()=>u.reduce((e,t)=>{const a=e.find(e=>e.username===t.username);return a?a.sessionCount+=1:e.push({username:t.username,sessionCount:1,connectedAt:t.connectedAt}),e},[]),[u]),V=r.useCallback((e=!1)=>{B.current?.scrollIntoView({behavior:e?"instant":"smooth"})},[]);r.useEffect(()=>{requestAnimationFrame(()=>{V()})},[c,V]);const q=r.useCallback((e,t="success")=>{F(e),W(t),E(!0)},[]),G=r.useCallback(async()=>{try{const e=new Date,t=`${e.getMonth()+1}/${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`;return(await a.post("/api/conversations",{title:`æ–°ä¼šè¯ ${t}`})).data.conversation}catch(e){return q("æ— æ³•åˆ›å»ºæ–°ä¼šè¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå¹¶é‡è¯•","error"),null}},[q]),J=r.useCallback(async(e=!1)=>{try{const t=await a.get("/api/conversations"),i=t.data?.conversations||[];S(i),e&&i.length>0?T(i[0].id):0===i.length&&T(null)}catch(t){S([]),T(null)}},[]),Q=r.useCallback(async e=>{if(!e)return d([]),void m(!1);m(!0);try{const t=await a.get(`/api/messages?conversation_id=${e}&limit=50`);d(t.data.messages)}catch(t){}finally{m(!1)}},[]),X=r.useCallback(async()=>{try{const e=await a.get("/api/conversations"),t=e.data?.conversations||[];S(t),t.length>0?T(t[0].id):(T(null),m(!1))}catch(e){S([]),T(null),m(!1)}},[]);U.current||(X(),U.current=!0),r.useEffect(()=>{L&&Q(L)},[L,Q]),r.useEffect(()=>{const e=()=>{V()};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[V]);const Y=r.useCallback(e=>{f(e.id)},[]),Z=r.useCallback(e=>{e&&e.id&&e.conversation_id&&e.conversation_id===L&&d(t=>[...t,e])},[L]),ee=r.useCallback(e=>{h(e)},[]),te=r.useCallback(e=>{d(t=>t.filter(t=>t.id!==e.messageId))},[]),ae=r.useCallback(()=>{J()},[J]),ie=r.useCallback(e=>{"created"===e.type?S(t=>t.some(t=>t.id===e.conversation.id)?t:[e.conversation,...t]):"updated"===e.type?S(t=>t.map(t=>String(t.id)===String(e.conversationId)?{...t,...e}:t)):"deleted"===e.type&&S(t=>{const a=t.filter(t=>String(t.id)!==String(e.conversationId));if(String(L)===String(e.conversationId)){const e=a.length>0?a[0].id:null;setTimeout(()=>T(e),0)}return a})},[L]),se=r.useCallback(e=>{e.conversationId===L&&e.userId===t?.id&&d([])},[L,t]);r.useEffect(()=>{const e=y(i),t=()=>Y(e);return e.on("connect",t),e.on("new_message",Z),e.on("online_users",ee),e.on("message_recalled",te),e.on("conversation_updated",ae),e.on("conversations_updated",ie),e.on("messages_cleared",se),()=>{e.off("connect",t),e.off("new_message",Z),e.off("online_users",ee),e.off("message_recalled",te),e.off("conversation_updated",ae),e.off("conversations_updated",ie),e.off("messages_cleared",se),v()}},[i,Y,Z,ee,te,ae,ie,se]);const ne=e=>{d(t=>t.filter(t=>t.id!==e))},le=e=>{e&&T(e)},re=async()=>{try{const e=await G();e&&(S(t=>t.some(t=>t.id===e.id)?t:[e,...t]),T(e.id))}catch(e){}},oe=r.useCallback(e=>{S(t=>t.filter(t=>t.id!==e)),L===e&&(S(t=>{const a=t.filter(t=>t.id!==e);return a.length>0&&a[0].id,a}),S(t=>{const a=t.filter(t=>t.id!==e),i=a.length>0?a[0].id:null;return L===e&&setTimeout(()=>T(i),0),a}))},[L]),ce=r.useMemo(()=>b&&Array.isArray(b)&&b.find(e=>e.id===L)?.title||"åŠ è½½ä¸­...",[b,L]);return e.jsxs("div",{className:"fixed inset-0 bg-taiji-gray-100 flex flex-col",ref:O,children:[e.jsx("div",{className:"flex-none z-50",children:e.jsx(o,{fixed:!1})}),e.jsxs("div",{className:"flex-1 flex overflow-hidden min-h-0 relative",children:[e.jsx("div",{className:"hidden lg:block h-full",children:e.jsx(z,{conversations:b,currentConversationId:L,onSelectConversation:le,onNewConversation:re,onDeleteConversation:oe,onRefresh:J})}),e.jsx(N,{children:M&&e.jsxs(e.Fragment,{children:[e.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 z-30 lg:hidden",onClick:()=>P(!1)}),e.jsx(w.div,{initial:{x:"-100%"},animate:{x:0},exit:{x:"-100%"},transition:{type:"spring",stiffness:300,damping:30},className:"absolute top-0 left-0 bottom-0 z-40 lg:hidden h-full",children:e.jsx(z,{conversations:b,currentConversationId:L,onSelectConversation:e=>{le(e),P(!1)},onNewConversation:()=>{re(),P(!1)},onDeleteConversation:e=>{oe(e),P(!1)},onRefresh:J})})]})}),e.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row md:gap-4 md:p-4",children:[e.jsxs("div",{className:"flex-1 flex flex-col bg-taiji-white md:rounded-2xl md:shadow-lg md:border-2 border-taiji-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"bg-taiji-black text-taiji-white px-3 md:px-6 py-2 md:py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx("button",{onClick:()=>P(!0),className:"p-2 -ml-2 rounded-full hover:bg-white/20 lg:hidden",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h16"})})}),e.jsx(n,{size:28,animate:!1,className:"md:w-8 md:h-8"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-base md:text-xl font-bold",children:ce}),e.jsxs("p",{className:"text-xs opacity-75",children:[K.length," äººåœ¨çº¿"]})]})]}),c.length>0&&e.jsxs(w.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>{L&&I(!0)},className:"px-3 py-1.5 md:px-4 md:py-2 bg-red-500 hover:bg-red-600 textç™½ text-xs md:text-sm rounded-lg transition-colors flex items-center gap-1.5",title:"æ¸…ç©ºèŠå¤©è®°å½•",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),e.jsx("span",{className:"hidden md:inline",children:"æ¸…ç©º"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 md:p-6",children:L?x?e.jsx(l,{message:"åŠ è½½æ¶ˆæ¯..."}):0===c.length?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(n,{size:80,animate:!0,className:"mx-auto mb-4"}),e.jsx("p",{className:"text-taiji-gray-400",children:"æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§"})]})}):e.jsxs(e.Fragment,{children:[e.jsx(N,{children:c.map((a,i)=>e.jsx(_,{message:a,isOwn:Boolean(t&&a&&a.user_id===t.id),currentSessionId:g,onRecall:ne},a?.id??i))}),e.jsx("div",{ref:B})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(n,{size:80,animate:!1,className:"mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-taiji-gray-400",children:"æ²¡æœ‰ä¼šè¯"}),e.jsx("p",{className:"text-taiji-gray-400 mt-2",children:"ç‚¹å‡»å·¦ä¾§â€œ+â€æŒ‰é’®åˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯"})]})})}),e.jsx($,{conversationId:L})]}),"root"===t.username&&e.jsxs("div",{className:"hidden lg:block w-64 bg-taiji-white rounded-xl md:rounded-2xl shadow-lg border-2 border-taiji-gray-200 p-4",children:[e.jsx("h3",{className:"text-base md:text-lg font-bold text-taiji-black mb-4",children:"åœ¨çº¿ç”¨æˆ·"}),0===K.length?e.jsx("p",{className:"text-sm text-taiji-gray-400 text-center py-8",children:"æš‚æ— åœ¨çº¿ç”¨æˆ·"}):e.jsx("div",{className:"space-y-2",children:K.map((a,i)=>e.jsxs(w.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:"flex items-center gap-3 p-3 rounded-lg bg-taiji-gray-100 hover:bg-taiji-gray-200 transition-colors",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("p",{className:"text-sm font-medium text-taiji-black truncate",children:[a.username,a.username===t.username&&e.jsx("span",{className:"text-xs text-taiji-gray-500 ml-2",children:"(ä½ )"}),a.sessionCount>1&&e.jsxs("span",{className:"text-xs text-taiji-gray-500 ml-2",children:["(",a.sessionCount,"ä¸ªä¼šè¯)"]})]})})]},i))})]})]})]}),e.jsx(k,{isOpen:D,onClose:()=>I(!1),onConfirm:async()=>{try{await a.delete(`/api/messages?conversation_id=${L}`),d([]),J()}catch(e){q("æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•","error")}},title:"æ¸…ç©ºèŠå¤©è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼",confirmText:"æ¸…ç©º",cancelText:"å–æ¶ˆ",type:"danger"}),e.jsx(C,{isOpen:R,onClose:()=>E(!1),message:A,type:H})]})}export{L as default};
