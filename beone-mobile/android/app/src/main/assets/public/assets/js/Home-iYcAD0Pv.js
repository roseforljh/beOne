import{u as e,j as t,T as a,a as i,C as s,b as l}from"./index-uVwVOvxz.js";import{r}from"./react-vendor-D3OtlHN5.js";import{H as n}from"./Header-TXnB3V-4.js";import{F as c,g as d,f as o,a as m,T as x,D as u,c as h}from"./socket-BCDjj6Tf.js";import{m as p,A as j}from"./utils-vendor-C4paqCkD.js";import{C as g,T as b}from"./Toast-CCnghxxx.js";import{F as f}from"./FilePreview-CPeYa2QP.js";import"./socket-vendor-Ba10ZAmw.js";function y({onUploadComplete:i}){const{user:s}=e(),[l,n]=r.useState(!1),[d,o]=r.useState(!1),[m,x]=r.useState([]),[u,h]=r.useState({}),j=r.useRef(null),[g,b]=r.useState("*/*"),[f,y]=r.useState(null),w=r.useRef([]);if(r.useEffect(()=>()=>{w.current.length>0&&w.current.forEach(e=>{try{e.abort()}catch(t){}}),w.current=[]},[]),s?.is_guest)return t.jsx("div",{className:"w-full",children:t.jsx("div",{className:"relative border-4 border-dashed rounded-xl md:rounded-2xl p-4 md:p-8 bg-taiji-gray-50 border-taiji-gray-300",children:t.jsxs("div",{className:"flex flex-col items-center justify-center space-y-3 md:space-y-4 text-center",children:[t.jsx(a,{size:60,animate:!1,className:"opacity-50 md:w-20 md:h-20"}),t.jsx("h3",{className:"text-base md:text-xl font-medium text-taiji-gray-500",children:"游客模式不支持上传文件"}),t.jsx("p",{className:"text-sm md:text-base text-taiji-gray-400",children:"您可以下载和预览公共文件，使用对话板功能"})]})})});const v=e=>{x(e);const t={};e.forEach((e,a)=>{t[a]=0}),h(t)};return t.jsx("div",{className:"w-full",children:t.jsxs(p.div,{className:"relative border-4 border-dashed rounded-xl md:rounded-2xl p-4 md:p-8 transition-all duration-300 "+(l?"border-taiji-black bg-taiji-gray-100":"border-taiji-gray-300 bg-taiji-white"),onDragOver:e=>{e.preventDefault(),n(!0)},onDragLeave:e=>{e.preventDefault(),n(!1)},onDrop:e=>{e.preventDefault(),n(!1);const t=Array.from(e.dataTransfer.files);t.length>0&&v(t)},whileHover:{scale:1.02},whileTap:{scale:.98},children:[t.jsx("input",{ref:j,type:"file",multiple:!0,accept:g,capture:f,className:"hidden",onChange:e=>{const t=Array.from(e.target.files);t.length>0&&v(t)}}),t.jsxs("div",{className:"flex flex-col items-center justify-center space-y-3 md:space-y-4",children:[t.jsx(a,{size:60,animate:l||d,className:"md:w-20 md:h-20"}),0===m.length&&!d&&t.jsxs(t.Fragment,{children:[t.jsx("h3",{className:"text-base md:text-xl font-medium text-taiji-black text-center",children:"拖拽文件到此处"}),t.jsx("p",{className:"text-sm md:text-base text-taiji-gray-500",children:"或者"}),t.jsx("div",{className:"hidden md:block",children:t.jsx("button",{className:"btn-primary text-sm md:text-base",onClick:()=>{b("*/*"),y(null),j.current?.click()},children:"选择文件"})}),t.jsx("div",{className:"md:hidden",children:t.jsx("button",{className:"btn-primary text-sm md:text-base",onClick:()=>{b("*/*"),y(null),j.current?.click()},children:"选择文件"})}),t.jsx("p",{className:"text-xs md:text-sm text-taiji-gray-400 text-center",children:"支持多文件上传，所有文件类型，最大 1GB+"})]}),m.length>0&&!d&&t.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"w-full space-y-3 md:space-y-4",children:[t.jsxs("div",{className:"text-center",children:[t.jsxs("p",{className:"text-base md:text-lg font-medium text-taiji-black",children:["已选择 ",m.length," 个文件"]}),t.jsx("div",{className:"mt-2 max-h-32 overflow-y-auto",children:m.map((e,a)=>t.jsxs("p",{className:"text-xs md:text-sm text-taiji-gray-600 truncate px-2",children:[a+1,". ",e.name," (",(e.size/1024/1024).toFixed(2)," MB)"]},a))})]}),t.jsxs("div",{className:"flex gap-3 md:gap-4 justify-center",children:[t.jsx("button",{className:"btn-primary text-sm md:text-base",onClick:async()=>{if(0===m.length)return;o(!0),w.current=[],await new Promise(e=>setTimeout(e,0));const e=m.map((e,t)=>{const a=new c(e,e=>{h(a=>({...a,[t]:Math.round(e)}))});return w.current.push(a),a.upload().then(a=>({index:t,file:e,result:a}))});try{const t=await Promise.all(e),a=t.filter(e=>e.result.cancelled),s=t.filter(e=>!e.result.success&&!e.result.cancelled),l=t.filter(e=>e.result.success);l.length>0&&l.forEach(e=>{i&&i(e.result.file)}),a.length>0&&alert(`${a.length} 个文件上传已取消`),s.length>0&&alert(`${s.length} 个文件上传失败`),x([]),h({}),w.current=[]}catch(t){alert("上传过程中出现错误")}o(!1)},children:"开始上传"}),t.jsx("button",{className:"btn-secondary text-sm md:text-base",onClick:()=>{x([]),h({})},children:"取消"})]})]}),d&&t.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},className:"w-full space-y-2 md:space-y-3 max-h-80 overflow-y-auto",children:[t.jsxs("div",{className:"text-center mb-3",children:[t.jsxs("p",{className:"text-base md:text-lg font-medium text-taiji-black",children:["上传中... (",Object.keys(u).length,"/",m.length,")"]}),t.jsx("button",{onClick:()=>{w.current.forEach(e=>{e.abort()}),o(!1),x([]),h({}),w.current=[]},className:"mt-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors",children:"取消上传"})]}),m.map((e,a)=>{const i=u[a]||0;return t.jsxs("div",{className:"bg-taiji-white rounded-lg p-3",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("p",{className:"text-xs md:text-sm text-taiji-black truncate flex-1 mr-2",children:e.name}),t.jsxs("span",{className:"text-xs md:text-sm font-bold text-taiji-black",children:[i,"%"]})]}),t.jsx("div",{className:"w-full bg-taiji-gray-200 rounded-full h-2 overflow-hidden",children:t.jsx(p.div,{className:"bg-taiji-black h-full",initial:{width:0},animate:{width:`${i}%`},transition:{duration:.3}})})]},a)})]})]})]})})}function w({file:e,onUpdate:a,onDelete:n,onPreview:c}){const[h,j]=r.useState(!1),[f,y]=r.useState(!1),[w,v]=r.useState(!1),[N,k]=r.useState(""),[_,C]=r.useState("success"),[S,D]=r.useState(!1),[T,F]=r.useState(!1),E=r.useRef(null),$=e.mimetype?.startsWith("image/");r.useEffect(()=>{const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&(F(!0),e.disconnect())})},{rootMargin:"50px"});return E.current&&e.observe(E.current),()=>e.disconnect()},[]);const P=(e,t="success")=>{k(e),C(t),v(!0)};return t.jsxs(p.div,{ref:E,className:"card p-4 group",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},whileHover:{y:-5},layout:!0,children:[t.jsxs("div",{className:"relative w-full h-48 bg-taiji-gray-100 rounded-lg mb-3 overflow-hidden flex items-center justify-center",children:[$&&T?t.jsxs(t.Fragment,{children:[!S&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:t.jsx("div",{className:"w-8 h-8 border-4 border-taiji-gray-300 border-t-taiji-black rounded-full animate-spin"})}),t.jsx("img",{src:i.getThumbnailUrl(e.id),alt:e.original_name,className:"w-full h-full object-cover transition-opacity duration-300 "+(S?"opacity-100":"opacity-0"),loading:"lazy",onLoad:()=>D(!0),onError:e=>{e.target.style.display="none",e.target.nextSibling.style.display="flex"}})]}):null,t.jsx("div",{className:"flex items-center justify-center w-full h-full "+($&&T&&!S||$?"hidden":""),children:t.jsx("span",{className:"text-6xl",children:d(e.mimetype)})}),1===e.is_public&&t.jsx("div",{className:"absolute top-2 right-2 bg-taiji-black text-taiji-white px-2 py-1 rounded text-xs font-medium",children:"公开"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("h3",{className:"text-sm font-medium text-taiji-black truncate",title:e.original_name,children:e.original_name}),t.jsx("p",{className:"text-xs text-taiji-gray-500",children:o(e.size)}),t.jsx("p",{className:"text-xs text-taiji-gray-400",children:new Date(e.created_at).toLocaleString("zh-CN")})]}),t.jsxs("div",{className:"mt-4 space-y-2",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:c,className:"flex-1 px-3 py-2 bg-taiji-white text-taiji-black border border-taiji-gray-300 rounded-lg text-xs font-medium hover:bg-taiji-gray-100 transition-colors",children:"预览"}),t.jsx("button",{onClick:async()=>{if(s.isNativePlatform())try{if("granted"!==(await m.requestPermissions()).publicStorage)return void(await x.show({text:"需要存储权限才能下载文件",duration:"long"}));await x.show({text:`开始下载 ${e.original_name}...`,duration:"short"});const t=(await l.get(`/api/files/${e.id}/download`,{responseType:"blob"})).data,a=new FileReader;a.onloadend=async()=>{const t=a.result;try{await m.writeFile({path:e.original_name,data:t,directory:u.Documents}),await x.show({text:`${e.original_name} 已保存成功`,duration:"long"})}catch(i){await x.show({text:`文件保存失败: ${i.message}`,duration:"long"})}},a.readAsDataURL(t)}catch(t){await x.show({text:`下载失败: ${t.message}`,duration:"long"})}else window.open(i.getDownloadUrl(e.id),"_blank")},className:"flex-1 px-3 py-2 bg-taiji-black text-taiji-white rounded-lg text-xs font-medium hover:bg-taiji-gray-800 transition-colors",children:"下载"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:async()=>{try{const t=await i.toggleVisibility(e.id);a&&a({...e,is_public:t.is_public}),P(t.is_public?"已设为公开":"已设为私有","success")}catch(t){P("切换失败","error")}},className:"flex-1 px-3 py-2 bg-taiji-white text-taiji-black border border-taiji-gray-300 rounded-lg text-xs font-medium hover:bg-taiji-gray-100 transition-colors",children:e.is_public?"设为私有":"设为公开"}),t.jsx("button",{onClick:()=>{y(!0)},disabled:h,className:"flex-1 px-3 py-2 bg-red-500 text-white rounded-lg text-xs font-medium hover:bg-red-600 transition-colors disabled:opacity-50",children:h?"...":"删除"})]})]}),t.jsx(g,{isOpen:f,onClose:()=>y(!1),onConfirm:async()=>{j(!0);try{await i.deleteFile(e.id),n&&n(e.id),P("文件已删除","success")}catch(t){P("删除失败","error"),j(!1)}},title:"删除文件",message:`确定要删除 "${e.original_name}" 吗？此操作不可恢复！`,confirmText:"删除",cancelText:"取消",type:"danger"}),t.jsx(b,{isOpen:w,onClose:()=>v(!1),message:N,type:_})]})}function v(){const{user:a,token:s}=e(),[l,c]=r.useState([]),[d,o]=r.useState(!0),[m,x]=r.useState("all"),[u,g]=r.useState(null);r.useEffect(()=>{b();const e=h(s),t=e=>{c(t=>t.some(t=>t.id===e.id)?t:[e,...t])},a=e=>{c(t=>t.map(t=>t.id===e.id?{...t,is_public:e.is_public}:t))},i=e=>{c(t=>t.filter(t=>t.id!==e.id)),setTimeout(()=>{b(!1)},100)};return e.on("file_uploaded",t),e.on("file_updated",a),e.on("file_deleted",i),()=>{e.off("file_uploaded",t),e.off("file_updated",a),e.off("file_deleted",i)}},[s]);const b=async(e=!1)=>{o(!0);try{const t=await i.getFiles(e);c(t||[])}catch(t){c([])}o(!1)},v=e=>{c(l.map(t=>t.id===e.id?e:t))},N=e=>{c(l.filter(t=>t.id!==e)),setTimeout(()=>{b(!1)},200)},k=(l||[]).filter(e=>"public"===m?1===e.is_public:"private"!==m||0===e.is_public);return t.jsxs("div",{className:"min-h-screen bg-taiji-gray-100",children:[t.jsx(n,{}),t.jsxs("main",{className:"max-w-7xl mx-auto px-3 md:px-4 py-4 md:py-8",style:{paddingTop:"calc(60px + env(safe-area-inset-top))"},children:[t.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mb-6 md:mb-12",children:[t.jsx("h2",{className:"text-xl md:text-2xl font-bold text-taiji-black mb-3 md:mb-4",children:a?.is_guest?"公共文件":"上传文件"}),t.jsx(y,{onUploadComplete:e=>{c([{...e,is_public:0,created_at:(new Date).toISOString()},...l])}})]}),!a?.is_guest&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-3 md:gap-0 mb-4 md:mb-6",children:[t.jsx("h2",{className:"text-xl md:text-2xl font-bold text-taiji-black",children:"我的文件"}),t.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2 md:pb-0",children:[t.jsxs("button",{onClick:()=>x("all"),className:"px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium transition-colors whitespace-nowrap "+("all"===m?"bg-taiji-black text-taiji-white":"bg-taiji-white text-taiji-black border border-taiji-gray-300 hover:bg-taiji-gray-100"),children:["全部 (",l.length,")"]}),t.jsxs("button",{onClick:()=>x("public"),className:"px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium transition-colors whitespace-nowrap "+("public"===m?"bg-taiji-black text-taiji-white":"bg-taiji-white text-taiji-black border border-taiji-gray-300 hover:bg-taiji-gray-100"),children:["公开 (",l.filter(e=>1===e.is_public).length,")"]}),t.jsxs("button",{onClick:()=>x("private"),className:"px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium transition-colors whitespace-nowrap "+("private"===m?"bg-taiji-black text-taiji-white":"bg-taiji-white text-taiji-black border border-taiji-gray-300 hover:bg-taiji-gray-100"),children:["私有 (",l.filter(e=>0===e.is_public).length,")"]})]})]}),d?t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:[1,2,3,4,5,6,7,8].map(e=>t.jsxs("div",{className:"card p-4 animate-pulse",children:[t.jsx("div",{className:"w-full h-48 bg-taiji-gray-200 rounded-lg mb-3"}),t.jsx("div",{className:"h-4 bg-taiji-gray-200 rounded mb-2"}),t.jsx("div",{className:"h-3 bg-taiji-gray-200 rounded w-2/3 mb-2"}),t.jsx("div",{className:"h-3 bg-taiji-gray-200 rounded w-1/2"})]},e))}):0===k.length?t.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-16",children:t.jsx("p",{className:"text-taiji-gray-400 text-lg",children:"暂无文件"})}):t.jsx(p.div,{layout:!0,className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-8",children:t.jsx(j,{children:k.map(e=>t.jsx(w,{file:e,onUpdate:v,onDelete:N,onPreview:()=>g(e)},e.id))})})]})]}),u&&t.jsx(f,{file:u,onClose:()=>g(null)})]})}export{v as default};
