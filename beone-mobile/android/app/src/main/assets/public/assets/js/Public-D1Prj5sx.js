import{u as e,a as t,j as a,T as i,L as s,C as l,b as r}from"./index-uVwVOvxz.js";import{r as n,L as o}from"./react-vendor-D3OtlHN5.js";import{H as d}from"./Header-TXnB3V-4.js";import{F as c}from"./FilePreview-CPeYa2QP.js";import{c as m,g as x,f as g,a as p,T as j,D as f}from"./socket-BCDjj6Tf.js";import{m as h}from"./utils-vendor-C4paqCkD.js";import"./socket-vendor-Ba10ZAmw.js";function u(){const{user:u,token:y}=e(),[b,w]=n.useState([]),[v,N]=n.useState(!0),[_,k]=n.useState(null);n.useEffect(()=>{if(T(),u&&y){const e=m(y),t=e=>{1===e.is_public&&w(t=>t.some(t=>t.id===e.id)?t:[e,...t])},a=e=>{w(t=>{if(1!==e.is_public)return t.filter(t=>t.id!==e.id);if(t.some(t=>t.id===e.id))return t.map(t=>t.id===e.id?{...t,is_public:e.is_public}:t);T();return t})},i=e=>{w(t=>t.filter(t=>t.id!==e.id)),setTimeout(()=>{T()},100)};return e.on("file_uploaded",t),e.on("file_updated",a),e.on("file_deleted",i),()=>{e.off("file_uploaded",t),e.off("file_updated",a),e.off("file_deleted",i)}}},[u,y]);const T=async()=>{N(!0);try{const e=await t.getPublicFiles(!1);w(Array.isArray(e)?e:[])}catch(e){w([])}N(!1)};return a.jsxs("div",{className:"min-h-screen bg-taiji-gray-100",children:[u?a.jsx(d,{}):a.jsx("header",{className:"bg-taiji-white border-b-2 border-taiji-gray-200 sticky top-0 z-40",style:{paddingTop:"env(safe-area-inset-top)"},children:a.jsx("div",{className:"max-w-7xl mx-auto px-4 py-3",style:{paddingLeft:"calc(1rem + env(safe-area-inset-left))",paddingRight:"calc(1rem + env(safe-area-inset-right))"},children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(o,{to:"/public",className:"flex items-center gap-2",children:[a.jsx(i,{size:36,animate:!1}),a.jsxs("div",{children:[a.jsx("h1",{className:"text-base md:text-lg font-bold text-taiji-black",children:"太极"}),a.jsx("p",{className:"text-xs text-taiji-gray-500",children:"文件传输"})]})]}),a.jsx(o,{to:"/login",className:"px-4 py-2 bg-taiji-black text-taiji-white rounded-lg hover:bg-taiji-gray-800 transition-colors text-sm font-medium",children:"登录"})]})})}),a.jsx("main",{className:"max-w-7xl mx-auto px-3 md:px-4 py-4 md:py-8",style:{paddingTop:u?"calc(60px + env(safe-area-inset-top))":"0"},children:a.jsxs(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[a.jsxs("div",{className:"mb-6 md:mb-8",children:[a.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-taiji-black mb-2",children:"公开文件"}),a.jsx("p",{className:"text-sm md:text-base text-taiji-gray-500",children:"这些文件对所有人公开可见"})]}),v?a.jsx(s,{message:"加载公开文件..."}):0===b.length?a.jsx(h.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-16",children:a.jsx("p",{className:"text-taiji-gray-400 text-lg",children:"暂无公开文件"})}):a.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:b.map(e=>{const i=e.mimetype?.startsWith("image/");return a.jsxs(h.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},whileHover:{y:-5},className:"card p-4",children:[a.jsxs("div",{className:"relative w-full h-48 bg-taiji-gray-100 rounded-lg mb-3 overflow-hidden flex items-center justify-center",children:[i?a.jsx("img",{src:t.getThumbnailUrl(e.id),alt:e.original_name,className:"w-full h-full object-cover",onError:e=>{e.target.style.display="none",e.target.nextSibling.style.display="flex"}}):null,a.jsx("div",{className:"flex items-center justify-center w-full h-full "+(i?"hidden":""),children:a.jsx("span",{className:"text-6xl",children:x(e.mimetype)})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("h3",{className:"text-sm font-medium text-taiji-black truncate",title:e.original_name,children:e.original_name}),a.jsx("p",{className:"text-xs text-taiji-gray-500",children:g(e.size)}),a.jsx("p",{className:"text-xs text-taiji-gray-400",children:new Date(e.created_at).toLocaleString("zh-CN")})]}),a.jsxs("div",{className:"mt-4 flex gap-2",children:[a.jsx("button",{onClick:()=>(e=>{k(e)})(e),className:"flex-1 px-4 py-2 bg-taiji-white border border-taiji-gray-300 text-taiji-black rounded-lg text-sm font-medium hover:bg-taiji-gray-100 transition-colors",children:"预览"}),a.jsx("button",{onClick:()=>(async e=>{if(l.isNativePlatform())try{if("granted"!==(await p.requestPermissions()).publicStorage)return void(await j.show({text:"需要存储权限才能下载文件",duration:"long"}));await j.show({text:`开始下载 ${e.original_name}...`,duration:"short"});const t=(await r.get(`/api/files/${e.id}/download`,{responseType:"blob"})).data,a=new FileReader;a.onloadend=async()=>{const t=a.result;try{await p.writeFile({path:e.original_name,data:t,directory:f.Documents}),await j.show({text:`${e.original_name} 已保存成功`,duration:"long"})}catch(i){await j.show({text:`文件保存失败: ${i.message}`,duration:"long"})}},a.readAsDataURL(t)}catch(a){await j.show({text:`下载失败: ${a.message}`,duration:"long"})}else window.open(t.getDownloadUrl(e.id),"_blank")})(e),className:"flex-1 px-4 py-2 bg-taiji-black text-taiji-white rounded-lg text-sm font-medium hover:bg-taiji-gray-800 transition-colors",children:"下载"})]})]},e.id)})})]})}),_&&a.jsx(c,{file:_,onClose:()=>k(null)})]})}export{u as default};
